<!DOCTYPE html>
<html>
<head>


    <style>
        body {
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            font-family: Arial, sans-serif;
            background: #0b1215;
            color: white;
        }



        #toolbar {
            background: #162025;
            padding: 8px;
            border-bottom: 1px solid #222;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        button {
            padding: 5px 10px;
            font-size: 14px;
            background: #1c2a2f;
            color: white;
            border: 1px solid #2c3a40;
            cursor: pointer;
        }

        button:hover {
            background: #26353b;
        }

        #textWrapper {
            position: relative;
            flex: 1;
            display: flex;
            justify-content: center;
        }

        /* LEFT LINE */
        #textWrapper::before {
            content: "";
            position: absolute;
            left: calc(50% - ((100% - 400px) / 2) + 20px);
            top: 0;
            bottom: 0;
            width: 1px;
            background: #2c3a40;
            opacity: 0.7;
            pointer-events: none;
        }

        /* RIGHT LINE */
        #textWrapper::after {
            content: "";
            position: absolute;
            right: calc(50% - ((100% - 400px) / 2) + 12px);
            top: 0;
            bottom: 0;
            width: 1px;
            background: #2c3a40;
            opacity: 0.7;
            pointer-events: none;
        }

        textarea {
	    cursor: text;
            width: calc(100% - 425px);
            margin: 0 auto;
            border: none;
            padding: 10px 10px 10px 30px;
            box-sizing: border-box;
            font-size: 18px;
            font-family: "Segoe UI", Arial, sans-serif;
            resize: none;
            outline: none;
            background: #0b1215;
            color: #deded1;
	    line-height: 26px;
	    word-spacing: -1px;
	    letter-spacing: 0.5px;
        }

        /* Scrollbar */
        textarea::-webkit-scrollbar {
	    cursor: default;
            width: 12px;
        }
        textarea::-webkit-scrollbar-track {
	    cursor: default;
            background: #111a1e;
        }
        textarea::-webkit-scrollbar-thumb {
	    cursor: default;
            background: #1f2a2f;
            border-radius: 6px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #2c3a40;
        }
	textarea::-webkit-scrollbar-corner { 
	    cursor: default;
	}
        /* Size popup */
#fontPopup {
    position: absolute;
    left: 90px;          
    top: 50px;          
    background: #111a1e;
    padding: 8px 14px;
    border-radius: 6px;
    border: 1px solid #2c3a40;
    color: white;
    font-size: 14px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease;
    z-index: 20;
}


        /* Counter */
        #counterBox {
            position: fixed;
            bottom: 10px;
            right: 0px;
            background: pink;
            color: black;
            padding: 5px 8px;
            border-radius: 6px;
            font-size: 14px;
            border: 1px solid #000;
            opacity: 0.85;
        }

        /* Tabs */
#pageTabs {
    display: contents;   /* lets tabs flow directly into #tabsRow */
}


.pageTab {
    position: relative;
    pointer-events: auto;
    padding: 5px 10px;
    background: #1c2a2f;
    border: 1px solid #2c3a40;
    cursor: grab;
    border-radius: 4px;
    color: white;
    user-select: none;

    max-width: 120px;          /* prevents stretching */
    white-space: nowrap;       /* keeps text on one line */
    overflow: hidden;          /* hides overflow */
    text-overflow: ellipsis;   /* adds "..." when too long */
    flex-shrink: 0;            /* prevents shrinking weirdly */
}



        .pageTab:active {
            cursor: grabbing;
        }

        .pageTab.active {
            background: #324148;
            border-color: #4a5a60;
        }

        #addPageBtn {
            padding: 5px 10px;
            background: #1c2a2f;
            border: 1px solid #2c3a40;
            color: white;
            cursor: pointer;
            border-radius: 4px;
        }

        #addPageBtn:hover {
            background: #26353b;
        }

        /* Right-click menu */
        #deleteMenu {
            position: absolute;
            background: #1c2a2f;
            border: 1px solid #2c3a40;
            padding: 0;
            border-radius: 4px;
            color: white;
            display: none;
            z-index: 9999;
        }

        .menuItem {
            padding: 6px 12px;
            cursor: pointer;
            border-bottom: 1px solid #2c3a40;
        }

        .menuItem:hover {
            background: #26353b;
        }

        .menuItem:last-child {
            border-bottom: none;
        }

        /* Rename input */
        .renameInput {
            width: 90px;
            padding: 3px;
            font-size: 14px;
            background: #1c2a2f;
            border: 1px solid #4a5a60;
            color: white;
            border-radius: 3px;
        }
.backup-restore-container {
    display: flex;
    width: 100%;
    margin: 0;
    padding: 0;
}



.toolbar {
    margin: 0;
    padding: 0;
}



#backupAllBtn, #restoreBtn {
    width: 50%;
    padding: 10px;
    font-size: 16px;
    cursor: pointer;
}


#tabsWrapper {
    position: relative;
    width: 100%;
}


#tabsRow {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: center;
}

#addPageBtn {
    flex-shrink: 0;      /* prevents shrinking */
    height: 28px;        /* match tab height */
    order: 9999;        /* always stays at the end */
}


/* Left side: textarea */
#textWrapper {
    position: relative; /* anchor for the warning box */
    flex: 1;
    display: flex;
    justify-content: center;
}

.data-warning-top {
    position: absolute;
    top: calc(100% + 16px);   /* directly under the tabs */
    right: 0px;            /* OUTSIDE textarea + OUTSIDE scrollbar */
    width: 150px;

    background: #1c2a2f;
    color: #ffb3c6;
    border: 1px solid #2c3a40;
    border-radius: 6px;

    padding: 10px 12px;
    font-size: 12px;
    line-height: 1.3;
    text-align: right;

    opacity: 0.9;
    pointer-events: none;
    z-index: 999;
}
#saveStatus {
    position: absolute;
    top: calc(100% + 16px);  /* same vertical logic as warning box */
    left: -300px;                
    font-size: 12px;
    color: #9bb2c9;
    opacity: 0.8;
    pointer-events: none;
    z-index: 999;
}


</style>
</head>

<body>

<div class="backup-restore-container">
    <button id="backupAllBtn">Backup All Pages</button>
    <button id="restoreBtn">Restore Backup</button>
</div>

<div id="toolbar">
    <button id="clearBtn">Clear</button>

    <button id="fontUp">A+</button>
    <button id="fontDown">A-</button>
    <button id="fontReset">Reset</button>
    <button id="exportBtn">Export</button>

    <div id="tabsWrapper">

        <div id="tabsRow">
            <div id="pageTabs"></div>
            <button id="addPageBtn">+</button>
        </div>
    <span id="saveStatus"></span>

        <div class="data-warning-top">
            Before clearing Cookies And Other Site Data or Re-installing Your Browser, BACKUP Your NOTES!
            And when Restoring DONT CREATE NEW PAGES THEY WILL BE OVERWRITTEN!!!
        </div>

    </div>
</div>

<!-- Right-click menu -->
<div id="deleteMenu">
    <div class="menuItem" id="renamePageBtn">Rename Page</div>
    <div class="menuItem" id="deletePageBtn">Delete Page</div>
</div>

<div id="fontPopup">Size: 16</div>

<div id="textWrapper">
    <textarea id="noteArea"
          placeholder="Start typing here..."
          autocomplete="off"
          autocorrect="off"
          autocapitalize="off"
          spellcheck="false"></textarea>

</div>



<div id="charCountContainer">
    <!-- your character + word count elements -->
</div>

<div id="counterBox">
    0 characters • 0 words
</div>
<script>

let undoStack = [];
let redoStack = [];
let undoLimit = 5000;

let lastClearedText = "";
let canUndoClear = false;

/* ---------------------------
   PAGE STORAGE (ARRAY)
--------------------------- */
let pages = JSON.parse(localStorage.getItem("pages_v4")) || [
    { name: "Page 1", content: "" }
];

let currentPage = 0;

// Restore last opened page BEFORE rendering tabs
let savedPage = parseInt(localStorage.getItem("lastPage"), 10);
if (!isNaN(savedPage) && savedPage >= 0 && savedPage < pages.length) {
    currentPage = savedPage;
}

/* ---------------------------
   RENDER TABS
--------------------------- */
function renderTabs() {
    const tabContainer = document.getElementById("pageTabs");
    tabContainer.innerHTML = "";

    pages.forEach((page, i) => {
        const tab = document.createElement("div");
        tab.className = "pageTab" + (i === currentPage ? " active" : "");
        tab.textContent = page.name;
        tab.draggable = true;
        tab.title = page.name;

        tab.addEventListener("click", () => switchPage(i));

        tab.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            openMenu(e.pageX, e.pageY, i);
        });

        tab.addEventListener("dragstart", (e) => {
            e.dataTransfer.setData("text/plain", i);
        });

        tab.addEventListener("dragover", (e) => {
            e.preventDefault();
        });

        tab.addEventListener("drop", (e) => {
            e.preventDefault();
            const from = parseInt(e.dataTransfer.getData("text/plain"));
            const to = i;
            reorderPages(from, to);
        });

        tabContainer.appendChild(tab);
    });
}

function switchPage(i) {
    if (i < 0 || i >= pages.length) {
        console.warn("switchPage: invalid index", i);
        return;
    }

    pages[currentPage].content = noteArea.value;
    currentPage = i;

    localStorage.setItem("lastPage", currentPage);

    noteArea.value = pages[currentPage].content;

    updateCounter();
    savePages();
    renderTabs();
}

window.onload = () => {
    renderTabs();
    switchPage(currentPage);
    noteArea.value = pages[currentPage].content;
    updateCounter();
};

function savePages() {
    localStorage.setItem("pages_v4", JSON.stringify(pages));
}

/* ---------------------------
   REORDER PAGES
--------------------------- */
function reorderPages(from, to) {
    if (from === to) return;

    const moved = pages.splice(from, 1)[0];
    pages.splice(to, 0, moved);

    if (currentPage === from) currentPage = to;
    else if (currentPage > from && currentPage <= to) currentPage--;
    else if (currentPage < from && currentPage >= to) currentPage++;

    savePages();
    renderTabs();
}

/* ---------------------------
   ADD PAGE
--------------------------- */

document.getElementById("addPageBtn").onclick = () => {
    pages[currentPage].content = noteArea.value;

    const newIndex = pages.length + 1;
    pages.push({ name: "Page " + newIndex, content: "" });

    currentPage = pages.length - 1;
    noteArea.value = "";
    updateCounter();
    savePages();
    renderTabs();
};

/* ---------------------------
   RIGHT-CLICK MENU
--------------------------- */

const menu = document.getElementById("deleteMenu");
let menuTarget = null;

function openMenu(x, y, index) {
    menuTarget = index;
    menu.style.left = x + "px";
    menu.style.top = y + "px";
    menu.style.display = "block";
}

document.addEventListener("click", () => {
    menu.style.display = "none";
});

/* ---------------------------
   RENAME PAGE
--------------------------- */

document.getElementById("renamePageBtn").onclick = () => {
    const tab = document.querySelectorAll(".pageTab")[menuTarget];

    const input = document.createElement("input");
    input.type = "text";
    input.value = pages[menuTarget].name;
    input.className = "renameInput";

    tab.innerHTML = "";
    tab.appendChild(input);
    input.focus();
    input.select();

    function save() {
        const newName = input.value.trim();
        pages[menuTarget].name = newName || ("Page " + (menuTarget + 1));
        savePages();
        renderTabs();
    }

    input.addEventListener("blur", save);
    input.addEventListener("keydown", e => {
        if (e.key === "Enter") save();
    });
};

/* ---------------------------
   DELETE PAGE (WITH CONFIRM)
--------------------------- */

document.getElementById("deletePageBtn").onclick = () => {
    if (!confirm("Are you sure you want to delete this page?")) return;

    if (pages.length === 1) {
        alert("You must have at least one page.");
        return;
    }

    //  Save deleted page to undo stack
    undoStack.push({
        pageIndex: menuTarget,
        pageName: pages[menuTarget].name,
        pageContent: pages[menuTarget].content
    });

    if (undoStack.length > undoLimit) undoStack.shift();
    redoStack = [];

    // Delete the page
    pages.splice(menuTarget, 1);

    if (currentPage >= pages.length) {
        currentPage = pages.length - 1;
    }

    noteArea.value = pages[currentPage].content;
    updateCounter();
    savePages();
    renderTabs();
};


/* ---------------------------
   COUNTER
--------------------------- */

function updateCounter() {
    const text = noteArea.value;
    const chars = text.length;
    const words = text.trim() ? text.trim().split(/\s+/).length : 0;
    counterBox.textContent = `${chars} characters • ${words} words`;
}

/* ---------------------------
   AUTOSAVE
--------------------------- */

let saveTimeout;
noteArea.addEventListener("input", () => {
    updateCounter();
    saveStatus.textContent = "Typing...";

    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
        pages[currentPage].content = noteArea.value;
        savePages();
        saveStatus.textContent = "Saved.";
    }, 500);

});
noteArea.addEventListener("input", () => {
undoStack.push({
    pageIndex: currentPage,
    pageName: pages[currentPage].name,
    pageContent: noteArea.value   
});



    if (undoStack.length > undoLimit) {
        undoStack.shift();
    }

    redoStack = [];
});
let lastInputWasDelete = false;

noteArea.addEventListener("keydown", (e) => {
    if (e.key === "Backspace" || e.key === "Delete") {
        if (!lastInputWasDelete) {
            undoStack.push({
                pageIndex: currentPage,
                pageName: pages[currentPage].name,
                pageContent: noteArea.value
            });

            if (undoStack.length > undoLimit) undoStack.shift();
            redoStack = [];
        }
        lastInputWasDelete = true;
    } else {
        lastInputWasDelete = false;
    }
});






/* ---------------------------
   FONT CONTROLS
--------------------------- */

const fontPopup = document.getElementById("fontPopup");

function showPopup(size) {
    fontPopup.textContent = "Size: " + size;
    fontPopup.style.opacity = 1;
    setTimeout(() => fontPopup.style.opacity = 0, 3000);
}

function updateFont(size) {
    noteArea.style.fontSize = size + "px";
    localStorage.setItem("fontSize", size);
    showPopup(size);
}

document.getElementById("fontUp").onclick = () => {
    let size = parseInt(getComputedStyle(noteArea).fontSize);
    updateFont(size + 2);
};

document.getElementById("fontDown").onclick = () => {
    let size = parseInt(getComputedStyle(noteArea).fontSize);
    updateFont(Math.max(8, size - 2));
};

document.getElementById("fontReset").onclick = () => updateFont(16);

/* ---------------------------
   CLEAR + EXPORT
--------------------------- */

document.getElementById("clearBtn").addEventListener("click", () => {
    if (confirm("Are you sure you want to clear this page?")) {

undoStack.push({
    pageIndex: currentPage,
    pageName: pages[currentPage].name,
    pageContent: noteArea.value 
});

        redoStack = [];

        noteArea.value = "";
        saveCurrentPage();
	updateCounter();
    }
});

document.addEventListener("keydown", (e) => {
    if (e.ctrlKey && e.key === "z") {
        e.preventDefault();

        if (undoStack.length > 0) {
            const previous = undoStack.pop();

            // Save current state to redo
            redoStack.push({
                pageIndex: currentPage,
                pageName: pages[currentPage].name,
                pageContent: noteArea.value
            });

            // Clamp index
            let idx = previous.pageIndex;
            if (idx < 0) idx = 0;
            if (idx > pages.length) idx = pages.length;

            // Recreate page if missing
            if (!pages[idx]) {
                pages.splice(idx, 0, {
                    name: previous.pageName,
                    content: previous.pageContent
                });
                savePages();
                renderTabs();
            }

            // Switch to restored page
            switchPage(idx);

            // Restore content
            noteArea.value = previous.pageContent;
            saveCurrentPage();
            updateCounter();
        }
    }
});

document.addEventListener("keydown", (e) => {
    if (e.ctrlKey && e.key.toLowerCase() === "y") {
        e.preventDefault();

        if (redoStack.length > 0) {
            const next = redoStack.pop();

            // Save current state to undo
            undoStack.push({
                pageIndex: currentPage,
                pageName: pages[currentPage].name,
                pageContent: noteArea.value
            });

            // Clamp index
            let idx = next.pageIndex;
            if (idx < 0) idx = 0;
            if (idx > pages.length) idx = pages.length;

            // Recreate page if missing
            if (!pages[idx]) {
                pages.splice(idx, 0, {
                    name: next.pageName,
                    content: next.pageContent
                });
                savePages();
                renderTabs();
            }

            // Switch to restored page
            switchPage(idx);

            // Restore content
            noteArea.value = next.pageContent;
            saveCurrentPage();
            updateCounter();
        }
    }
});






document.getElementById("exportBtn").onclick = () => {
    const blob = new Blob([noteArea.value], { type: "text/plain" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = pages[currentPage].name + ".txt";
    a.click();

    URL.revokeObjectURL(url);
};

/* ---------------------------
   INIT
--------------------------- */

noteArea.value = pages[currentPage].content;
updateCounter();
renderTabs();

document.getElementById("backupAllBtn").addEventListener("click", function () {
    const pages = JSON.parse(localStorage.getItem("pages_v4") || "[]");

    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, "0");
    const dd = String(now.getDate()).padStart(2, "0");

    const filename = `notepad-backup ${yyyy}-${mm}-${dd}.json`;

    const blob = new Blob([JSON.stringify(pages, null, 2)], {
        type: "application/json"
    });

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
});


document.getElementById("restoreBtn").addEventListener("click", function () {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = ".json";

    input.onchange = function (event) {
        const file = event.target.files[0];
        const reader = new FileReader();

        reader.onload = function () {
            try {
                const pages = JSON.parse(reader.result);
                localStorage.setItem("pages_v4", JSON.stringify(pages));
                alert("Restore complete! Reload the page to see your notes.");
            } catch (e) {
                alert("Invalid backup file.");
            }
        };

        reader.readAsText(file);
    };

    input.click();
});
function saveCurrentPage() {
    pages[currentPage].content = noteArea.value;
    localStorage.setItem("pages_v4", JSON.stringify(pages));
}

</script>

</body>
</html>
